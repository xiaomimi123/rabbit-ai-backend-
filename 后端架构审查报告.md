# Rabbit AI åç«¯æ¶æ„å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025å¹´  12/25
**å®¡æŸ¥èŒƒå›´**: `rabbit-ai-backend` é¡¹ç›®  
**æ¶æ„å˜æ›´**: ä»è´¨æŠ¼åˆçº¦æ¨¡å¼è¿ç§»åˆ° "Hold-to-Earn" (æŒå¸ç”Ÿæ¯) æ¨¡å¼

---

## 1. ğŸ“‚ é¡¹ç›®æ–‡ä»¶ç»“æ„æ ‘

```
rabbit-ai-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # åº”ç”¨å…¥å£ï¼šå¯åŠ¨ Fastify æœåŠ¡å™¨ + åå° Indexer
â”‚   â”œâ”€â”€ server.ts                   # Fastify æœåŠ¡å™¨é…ç½®å’Œè·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ config.ts                   # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆSupabaseã€RPCã€åˆçº¦åœ°å€ç­‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                        # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ health.ts          # å¥åº·æ£€æŸ¥è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts            # ç”¨æˆ·ä¿¡æ¯è·¯ç”± (GET /api/user/info, /api/user/team-rewards, /api/user/claims, /api/user/referrals)
â”‚   â”‚   â”‚   â”œâ”€â”€ asset.ts           # èµ„äº§è·¯ç”± (POST /api/asset/withdraw/apply, GET /api/asset/withdraw/history, GET /api/asset/earnings, GET /api/asset/rat-balance)
â”‚   â”‚   â”‚   â”œâ”€â”€ mining.ts          # æŒ–çŸ¿è·¯ç”± (POST /api/mining/verify-claim)
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.ts           # ç®¡ç†åå°è·¯ç”± (KPIsã€æç°ç®¡ç†ã€ç”¨æˆ·ç®¡ç†)
â”‚   â”‚   â”‚   â””â”€â”€ debug.ts           # è°ƒè¯•è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ schemas.ts             # Zod è¯·æ±‚éªŒè¯ Schema
â”‚   â”‚   â”œâ”€â”€ errors.ts              # é”™è¯¯å¤„ç†å·¥å…·
â”‚   â”‚   â””â”€â”€ adminAuth.ts           # ç®¡ç†åå°è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ user.ts                # ç”¨æˆ·ä¿¡æ¯æœåŠ¡ (getUserInfo, getTeamRewards, getClaimsHistory, getReferralHistory)
â”‚   â”‚   â”œâ”€â”€ withdraw.ts            # æç°æœåŠ¡ (applyWithdraw, getWithdrawHistory)
â”‚   â”‚   â”œâ”€â”€ verifyClaim.ts         # ç©ºæŠ•éªŒè¯æœåŠ¡ (verifyClaim, èƒ½é‡å¥–åŠ±)
â”‚   â”‚   â”œâ”€â”€ earnings.ts            # â­ æ”¶ç›Šè®¡ç®—æœåŠ¡ (calculateUserEarnings) - æ–°å¢
â”‚   â”‚   â””â”€â”€ admin.ts               # ç®¡ç†åå°æœåŠ¡ (KPIsã€æç°å®Œæˆã€ç”¨æˆ·è°ƒæ•´)
â”‚   â”‚
â”‚   â”œâ”€â”€ indexer/                    # é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨
â”‚   â”‚   â””â”€â”€ indexer.ts             # â­ æ ¸å¿ƒï¼šç›‘å¬ Claimed/ReferralReward/CooldownReset äº‹ä»¶
â”‚   â”‚
â”‚   â””â”€â”€ infra/                      # åŸºç¡€è®¾æ–½å±‚
â”‚       â”œâ”€â”€ supabase.ts            # Supabase å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ rpcPool.ts             # RPC è¿æ¥æ± ï¼ˆæ•…éšœè½¬ç§»ï¼‰
â”‚       â””â”€â”€ abis.ts                # åˆçº¦ ABI å®šä¹‰
â”‚
â”œâ”€â”€ db/
â”‚   â””â”€â”€ supabase.sql               # æ•°æ®åº“ Schemaï¼ˆusers, claims, withdrawals ç­‰ï¼‰
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ env.example                     # ç¯å¢ƒå˜é‡æ¨¡æ¿
```

### å…³é”®æ–‡ä»¶åŠŸèƒ½è¯´æ˜

- **`src/index.ts`**: åº”ç”¨å…¥å£ï¼ŒåŒæ—¶å¯åŠ¨ HTTP æœåŠ¡å™¨å’Œåå° Indexer å¾ªç¯
- **`src/indexer/indexer.ts`**: â­ **é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨**ï¼Œç›‘å¬ `RandomAirdrop` åˆçº¦çš„ `Claimed`ã€`ReferralReward`ã€`CooldownReset` äº‹ä»¶ï¼Œå†™å…¥æ•°æ®åº“
- **`src/services/withdraw.ts`**: æç°ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…å«èƒ½é‡æ£€æŸ¥ï¼ˆå·²ä¿®å¤èƒ½é‡é˜ˆå€¼å’Œæ¶ˆè€—è®¡ç®—ï¼‰
- **`src/services/user.ts`**: ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ï¼Œè¿”å›èƒ½é‡ã€USDT ä½™é¢ç­‰ï¼ŒåŒ…å«å†å²è®°å½•æŸ¥è¯¢ï¼ˆæ–°å¢ï¼‰
- **`src/services/earnings.ts`**: â­ **æ”¶ç›Šè®¡ç®—å¼•æ“**ï¼Œè®¡ç®—ç”¨æˆ·æŒå¸ç”Ÿæ¯æ”¶ç›Šï¼ˆæ–°å¢ï¼‰
- **`src/services/verifyClaim.ts`**: å‰ç«¯è°ƒç”¨ï¼ŒéªŒè¯ç©ºæŠ•äº¤æ˜“å¹¶å¥–åŠ±èƒ½é‡

---

## 2. ğŸ§  æ ¸å¿ƒé€»è¾‘æµå®¡è®¡

### âœ… 2.1 é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨ (Listener)

**çŠ¶æ€**: âœ… **å·²å®ç°**

**ä½ç½®**: `src/indexer/indexer.ts`

**åŠŸèƒ½**:
- ç›‘å¬ `RandomAirdrop` åˆçº¦çš„ä¸‰ä¸ªäº‹ä»¶ï¼š
  - `Claimed`: ç”¨æˆ·é¢†å–ç©ºæŠ• â†’ å†™å…¥ `claims` è¡¨
  - `ReferralReward`: æ¨èå¥–åŠ± â†’ å†™å…¥ `referral_rewards` è¡¨
  - `CooldownReset`: å†·å´é‡ç½® â†’ æ›´æ–°æ¨èäººçš„ `invite_count` å’Œ `energy_total`
- ä½¿ç”¨ `getLogs` æ‰¹é‡æŸ¥è¯¢ï¼Œæ”¯æŒ RPC é™æµé‡è¯•å’Œè‡ªé€‚åº”åŒºå—èŒƒå›´
- å¹‚ç­‰æ€§ä¿è¯ï¼šä½¿ç”¨ `tx_hash` ä½œä¸ºå”¯ä¸€é”®ï¼Œé¿å…é‡å¤å¤„ç†

**ä»£ç ç‰‡æ®µ**:
```typescript
// src/indexer/indexer.ts (lines 189-290)
async function runOnce(provider: ethers.providers.Provider): Promise<void> {
  // è·å–äº‹ä»¶æ—¥å¿—
  const eventTopics = [
    iface.getEventTopic('Claimed'),
    iface.getEventTopic('ReferralReward'),
    iface.getEventTopic('CooldownReset'),
  ];
  
  // å¤„ç† Claimed äº‹ä»¶
  if (parsed.name === 'Claimed') {
    await insertClaim({ ... });
  }
}
```

---

### âœ… 2.2 æ”¶ç›Šè®¡ç®—å¼•æ“ (Calculator)

**çŠ¶æ€**: âœ… **å·²å®ç°**

**ä½ç½®**: `src/services/earnings.ts`

**åŠŸèƒ½**:
- ä»é“¾ä¸Šå®æ—¶è¯»å– RAT ä½™é¢ï¼ˆä½¿ç”¨ `ERC20_ABI` è°ƒç”¨ `balanceOf`ï¼‰
- æŸ¥è¯¢æ•°æ®åº“ `claims` è¡¨è·å–é¦–æ¬¡é¢†å–æ—¶é—´ï¼ˆ`created_at`ï¼‰
- è®¡ç®—æŒå¸å¤©æ•°ï¼š`(Now - startTime) / (24*3600*1000)`
- æ ¹æ®ä½™é¢ç¡®å®š VIP ç­‰çº§å’Œæ—¥åˆ©ç‡ï¼š
  - < 10k RAT: 0% (æœªè¾¾åˆ°ç­‰çº§)
  - >= 10k: 2% (VIP1)
  - >= 50k: 4% (VIP2)
  - >= 100k: 6% (VIP3)
  - >= 200k: 10% (VIP4)
- è®¡ç®—å†å²æ€»æ”¶ç›Šï¼š`Balance Ã— 0.01 Ã— Rate Ã— Days`
- æŸ¥è¯¢ `withdrawals` è¡¨ç»Ÿè®¡å·²æç°æ€»é¢ï¼ˆPending + Completedï¼‰
- è®¡ç®—å¯é¢†æ”¶ç›Šï¼š`GrossEarnings - TotalWithdrawn`ï¼ˆå¦‚æœå°äº 0ï¼Œè¿”å› 0ï¼‰

**å®ç°ç»†èŠ‚**:
```typescript
// src/services/earnings.ts
export async function calculateUserEarnings(
  provider: ethers.providers.Provider,
  userAddress: string
): Promise<{
  pendingUsdt: string;      // å¯é¢†æ”¶ç›Šï¼ˆUSDTï¼‰
  dailyRate: number;         // æ—¥åˆ©ç‡ï¼ˆç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ 2 è¡¨ç¤º 2%ï¼‰
  currentTier: number;       // VIP ç­‰çº§ï¼ˆ0-4ï¼‰
  holdingDays: number;       // æŒå¸å¤©æ•°
  balance: string;           // å½“å‰ RAT ä½™é¢
  grossEarnings: string;     // å†å²æ€»æ”¶ç›Š
  totalWithdrawn: string;    // å·²æç°æ€»é¢
}>
```

**å½“å‰çŠ¶æ€**:
- âœ… `src/services/earnings.ts` å·²åˆ›å»ºå¹¶å®ç°
- âœ… `GET /api/asset/earnings` API å·²å®ç°
- âœ… `GET /api/asset/rat-balance` API å·²å®ç°
- âœ… ä»é“¾ä¸Šå®æ—¶è¯»å– RAT ä½™é¢çš„é€»è¾‘å·²å®ç°
- âœ… VIP ç­‰çº§å’Œæ—¥åˆ©ç‡è®¡ç®—é€»è¾‘å·²å®ç°ï¼ˆç¡¬ç¼–ç ï¼Œæœªæ¥å¯ä» `vip_tiers` è¡¨è¯»å–ï¼‰
- âœ… æŒå¸å¤©æ•°è®¡ç®—å·²å®ç°ï¼ˆåŸºäºé¦–æ¬¡ `claims.created_at`ï¼‰
- âš ï¸ `users.usdt_total` å­—æ®µæœªä½¿ç”¨ï¼ˆæ”¶ç›Šå®æ—¶è®¡ç®—ï¼Œä¸å­˜å‚¨ï¼‰

---

### âœ… 2.3 æç°é£æ§ (Gatekeeper)

**çŠ¶æ€**: âœ… **å·²å®ç°å¹¶ä¿®å¤**

**ä½ç½®**: `src/services/withdraw.ts`

**å½“å‰å®ç°**:
```typescript
// src/services/withdraw.ts (lines 29-38)
// âœ… å·²å–æ¶ˆæœ€ä½ 30 èƒ½é‡é—¨æ§›
const requiredEnergy = amount * 10; // 1 USDT = 10 Energyï¼Œæ— æœ€ä½é—¨æ§›
if (energyAvailable < requiredEnergy) {
  throw new ApiError('ENERGY_NOT_ENOUGH', ...);
}
```

**åŠŸèƒ½**:
1. âœ… **èƒ½é‡é˜ˆå€¼**: æ— ï¼ˆå·²å–æ¶ˆï¼‰
2. âœ… **èƒ½é‡æ¶ˆè€—è®¡ç®—**: `1 USDT = 10 Energy`ï¼ˆå·²ä¿®å¤ï¼‰
3. âœ… **ä½™é¢æ£€æŸ¥**: æ­£ç¡®æ£€æŸ¥ `usdtAvailable >= amount`
4. âœ… **é˜²é‡å¤æäº¤**: 5 åˆ†é’Ÿå†…é‡å¤è¯·æ±‚è¿”å›å·²å­˜åœ¨çš„è®°å½•
5. âœ… **èƒ½é‡é”å®š**: æç°æ—¶é”å®š `amount * 10` èƒ½é‡å’Œ `amount` USDT
6. âœ… **å›æ»šæœºåˆ¶**: å¦‚æœæ’å…¥å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šé”å®šçš„èƒ½é‡å’Œ USDT

---

### âŒ 2.4 åŠ¨æ€é…ç½® (Config)

**çŠ¶æ€**: âŒ **ç¼ºå¤±**

**é—®é¢˜**:
- VIP ç­‰çº§å’Œæ—¥åˆ©ç‡é…ç½®**ç¡¬ç¼–ç **åœ¨æ–‡æ¡£ä¸­ï¼Œä»£ç ä¸­æ²¡æœ‰å®ç°
- æ•°æ®åº“æœ‰ `system_config` è¡¨ï¼Œä½†**æ²¡æœ‰ä»£ç è¯»å–æˆ–æ›´æ–°é…ç½®**

**é¢„æœŸåŠŸèƒ½**:
- ä»æ•°æ®åº“ `system_config` è¡¨è¯»å– VIP ç­‰çº§é…ç½®
- æˆ–ä»ç¯å¢ƒå˜é‡/é…ç½®æ–‡ä»¶è¯»å–
- æ”¯æŒåŠ¨æ€æ›´æ–°ï¼ˆé€šè¿‡ Admin APIï¼‰

**å½“å‰çŠ¶æ€**:
- VIP ç­‰çº§é€»è¾‘ï¼ˆ10000/50000/100000/200000 RATï¼‰åªå­˜åœ¨äºæ–‡æ¡£ä¸­
- æ—¥åˆ©ç‡ï¼ˆ2%/4%/6%/10%ï¼‰åªå­˜åœ¨äºæ–‡æ¡£ä¸­
- ä»£ç ä¸­æ²¡æœ‰ `getDailyRate()` æˆ–ç±»ä¼¼çš„å‡½æ•°

---

## 3. ğŸ”Œ API æ¥å£æ¸…å•

### å·²å®ç°çš„ API

#### ç”¨æˆ·ç›¸å…³
- âœ… `GET /api/user/info?address=xxx`
  - è¿”å›ï¼šèƒ½é‡ã€USDT ä½™é¢ã€é‚€è¯·æ•°ã€æ¨èäººåœ°å€
  - å®ç°ï¼š`src/services/user.ts::getUserInfo()`

- âœ… `GET /api/user/team-rewards?address=xxx`
  - è¿”å›ï¼šå›¢é˜Ÿæ€»å¥–åŠ±ï¼ˆRATï¼‰
  - å®ç°ï¼š`src/services/user.ts::getTeamRewards()`

- âœ… `GET /api/user/claims?address=xxx` **â† æ–°å¢**
  - è¿”å›ï¼š`[{ txHash: string, amount: string, energy: number, createdAt: string }]`
  - åŠŸèƒ½ï¼šæŸ¥è¯¢ç”¨æˆ·ç©ºæŠ•é¢†å–å†å²
  - å®ç°ï¼š`src/services/user.ts::getClaimsHistory()`

- âœ… `GET /api/user/referrals?address=xxx` **â† æ–°å¢**
  - è¿”å›ï¼š`[{ address: string, energy: number, createdAt: string }]`
  - åŠŸèƒ½ï¼šæŸ¥è¯¢ç”¨æˆ·é‚€è¯·å†å²ï¼ˆä½œä¸ºæ¨èäººï¼‰
  - å®ç°ï¼š`src/services/user.ts::getReferralHistory()`

#### èµ„äº§ç›¸å…³
- âœ… `POST /api/asset/withdraw/apply`
  - è¯·æ±‚ä½“ï¼š`{ address: string, amount: string }`
  - åŠŸèƒ½ï¼šç”³è¯·æç°ï¼ˆæ£€æŸ¥èƒ½é‡å’Œä½™é¢ï¼‰
  - å®ç°ï¼š`src/services/withdraw.ts::applyWithdraw()`

- âœ… `GET /api/asset/withdraw/history?address=xxx`
  - è¿”å›ï¼šæç°å†å²è®°å½•
  - å®ç°ï¼š`src/services/withdraw.ts::getWithdrawHistory()`

- âœ… `GET /api/asset/earnings?address=xxx` **â† æ–°å¢**
  - è¿”å›ï¼š`{ pendingUsdt: string, dailyRate: number, currentTier: number, holdingDays: number }`
  - åŠŸèƒ½ï¼šè®¡ç®—å¹¶è¿”å›ç”¨æˆ·æ”¶ç›Šä¿¡æ¯
  - å®ç°ï¼š`src/services/earnings.ts::calculateUserEarnings()`

- âœ… `GET /api/asset/rat-balance?address=xxx` **â† æ–°å¢**
  - è¿”å›ï¼š`{ balance: string }`
  - åŠŸèƒ½ï¼šä»é“¾ä¸Šè¯»å– RAT ä½™é¢
  - å®ç°ï¼š`src/api/routes/asset.ts`ï¼ˆç›´æ¥è°ƒç”¨é“¾ä¸Šåˆçº¦ï¼‰

#### æŒ–çŸ¿ç›¸å…³
- âœ… `POST /api/mining/verify-claim`
  - è¯·æ±‚ä½“ï¼š`{ address: string, txHash: string, referrer: string }`
  - åŠŸèƒ½ï¼šéªŒè¯ç©ºæŠ•äº¤æ˜“ï¼Œå¥–åŠ±èƒ½é‡ +1
  - å®ç°ï¼š`src/services/verifyClaim.ts::verifyClaim()`

#### ç®¡ç†åå°
- âœ… `GET /api/admin/kpis` - ç³»ç»Ÿ KPIs
- âœ… `GET /api/admin/withdrawals/pending` - å¾…å¤„ç†æç°åˆ—è¡¨
- âœ… `POST /api/admin/withdrawals/:id/complete` - å®Œæˆæç°
- âœ… `POST /api/admin/withdrawals/:id/reject` - æ‹’ç»æç°
- âœ… `GET /api/admin/users?address=xxx` - ç”¨æˆ·è¯¦æƒ…
- âœ… `POST /api/admin/users/:address/energy` - è°ƒæ•´ç”¨æˆ·èƒ½é‡
- âœ… `POST /api/admin/users/:address/usdt` - è°ƒæ•´ç”¨æˆ· USDT

#### ç³»ç»Ÿ
- âœ… `GET /api/health` - å¥åº·æ£€æŸ¥

---

### âœ… å·²å®ç°çš„ APIï¼ˆä¹‹å‰ç¼ºå¤±ï¼Œç°å·²å®Œæˆï¼‰

1. âœ… **`GET /api/asset/earnings?address=xxx`**
   - è¿”å›ï¼š`{ pendingUsdt: string, dailyRate: number, currentTier: number, holdingDays: number }`
   - çŠ¶æ€ï¼šâœ… **å·²å®ç°**
   - å®ç°ï¼š`src/api/routes/asset.ts` + `src/services/earnings.ts`

2. âœ… **`GET /api/asset/rat-balance?address=xxx`**
   - è¿”å›ï¼š`{ balance: string }`
   - çŠ¶æ€ï¼šâœ… **å·²å®ç°**
   - å®ç°ï¼š`src/api/routes/asset.ts`ï¼ˆç›´æ¥ä»é“¾ä¸Šè¯»å–ï¼‰

3. âœ… **`GET /api/user/claims?address=xxx`**
   - è¿”å›ï¼š`[{ txHash: string, amount: string, energy: number, createdAt: string }]`
   - çŠ¶æ€ï¼šâœ… **å·²å®ç°**
   - å®ç°ï¼š`src/api/routes/user.ts` + `src/services/user.ts::getClaimsHistory()`

4. âœ… **`GET /api/user/referrals?address=xxx`**
   - è¿”å›ï¼š`[{ address: string, energy: number, createdAt: string }]`
   - çŠ¶æ€ï¼šâœ… **å·²å®ç°**
   - å®ç°ï¼š`src/api/routes/user.ts` + `src/services/user.ts::getReferralHistory()`

---

## 4. âš ï¸ ç¼ºå¤±æˆ–é£é™©æç¤º

### âœ… å·²å®Œæˆçš„å®ç°ï¼ˆä¹‹å‰ç¼ºå¤±ï¼Œç°å·²ä¿®å¤ï¼‰

#### 1. âœ… æ”¶ç›Šè®¡ç®—å¼•æ“å·²å®ç°
**çŠ¶æ€**: âœ… **å·²å®Œæˆ**

**å®ç°ä½ç½®**:
- `src/services/earnings.ts` - æ ¸å¿ƒè®¡ç®—é€»è¾‘
- `src/api/routes/asset.ts` - API è·¯ç”±

**åŠŸèƒ½**:
- âœ… ä»é“¾ä¸Šè¯»å– RAT ä½™é¢
- âœ… ä» `claims` è¡¨è·å–é¦–æ¬¡é¢†å–æ—¶é—´
- âœ… è®¡ç®—æŒå¸å¤©æ•°
- âœ… æ ¹æ®ä½™é¢ç¡®å®š VIP ç­‰çº§å’Œæ—¥åˆ©ç‡ï¼ˆç¡¬ç¼–ç ï¼Œæœªæ¥å¯ä» `vip_tiers` è¡¨è¯»å–ï¼‰
- âœ… è®¡ç®—æ”¶ç›Š = ä½™é¢ Ã— 0.01 Ã— æ—¥åˆ©ç‡ Ã— å¤©æ•°
- âœ… æŸ¥è¯¢å·²æç°æ€»é¢å¹¶è®¡ç®—å¯é¢†æ”¶ç›Š

**æ³¨æ„**: 
- `users.usdt_total` å­—æ®µæœªä½¿ç”¨ï¼ˆæ”¶ç›Šå®æ—¶è®¡ç®—ï¼Œä¸å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰

#### 2. âœ… æ”¶ç›ŠæŸ¥è¯¢ API å·²å®ç°
**çŠ¶æ€**: âœ… **å·²å®Œæˆ**

**å®ç°**:
- âœ… `GET /api/asset/earnings` - å·²å®ç°
- âœ… `GET /api/asset/rat-balance` - å·²å®ç°

#### 3. âœ… å†å²è®°å½•æŸ¥è¯¢ API å·²å®ç°
**çŠ¶æ€**: âœ… **å·²å®Œæˆ**

**å®ç°**:
- âœ… `GET /api/user/claims` - å·²å®ç°ï¼ˆæŸ¥è¯¢ `claims` è¡¨ï¼‰
- âœ… `GET /api/user/referrals` - å·²å®ç°ï¼ˆæŸ¥è¯¢ `claims` è¡¨ï¼Œ`referrer = address`ï¼Œå»é‡ï¼‰

---

### âœ… ä¸šåŠ¡é€»è¾‘é”™è¯¯å·²ä¿®å¤

#### 1. âœ… æç°èƒ½é‡é˜ˆå€¼å’Œæ¶ˆè€—è®¡ç®—å·²ä¿®å¤
**ä½ç½®**: `src/services/withdraw.ts:29-34`

**ä¿®å¤åçš„ä»£ç **:
```typescript
// âœ… å·²å–æ¶ˆæœ€ä½ 30 èƒ½é‡é—¨æ§›
const requiredEnergy = amount * 10; // 1 USDT = 10 Energyï¼Œæ— æœ€ä½é—¨æ§›
```

**ä¿®å¤å†…å®¹**:
- âœ… èƒ½é‡é˜ˆå€¼ï¼šå·²å–æ¶ˆï¼ˆåªéœ€æ»¡è¶³ 1 USDT = 10 èƒ½é‡çš„å…³ç³»ï¼‰
- âœ… èƒ½é‡æ¶ˆè€—ï¼šä» `amount` ä¿®å¤ä¸º `amount * 10`ï¼ˆ1 USDT = 10 Energyï¼‰
- âœ… èƒ½é‡é”å®šï¼šä½¿ç”¨ `energyCost = amount * 10` æ­£ç¡®é”å®šèƒ½é‡
- âœ… æ•°æ®åº“è®°å½•ï¼š`energy_locked_amount` å­—æ®µè®°å½•æ­£ç¡®çš„èƒ½é‡æ¶ˆè€—

---

### ğŸŸ  æ¶æ„è®¾è®¡é—®é¢˜

#### 1. æ”¶ç›Šæ•°æ®æ›´æ–°æœºåˆ¶ç¼ºå¤±
**é—®é¢˜**: 
- `users.usdt_total` å­—æ®µå­˜åœ¨ï¼Œä½†**æ²¡æœ‰å®šæ—¶ä»»åŠ¡æˆ–è§¦å‘å™¨æ›´æ–°å®ƒ**
- æ”¶ç›Šåº”è¯¥æ˜¯å®æ—¶è®¡ç®—çš„ï¼Œè¿˜æ˜¯åº”è¯¥å®šæœŸæ›´æ–°åˆ°æ•°æ®åº“ï¼Ÿ

**å»ºè®®**:
- **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**: å®æ—¶è®¡ç®—ï¼Œä¸å­˜å‚¨ `usdt_total`
  - æ¯æ¬¡æŸ¥è¯¢æ—¶ä»é“¾ä¸Šè¯»å–ä½™é¢ï¼Œè®¡ç®—æ”¶ç›Š
  - ä¼˜ç‚¹ï¼šæ•°æ®å‡†ç¡®ï¼Œæ— éœ€åŒæ­¥
  - ç¼ºç‚¹ï¼šæ¯æ¬¡æŸ¥è¯¢éœ€è¦ RPC è°ƒç”¨

- **æ–¹æ¡ˆ B**: å®šæ—¶ä»»åŠ¡æ›´æ–° `usdt_total`
  - åå°ä»»åŠ¡å®šæœŸæ‰«ææ‰€æœ‰ç”¨æˆ·ï¼Œè®¡ç®—å¹¶æ›´æ–°æ”¶ç›Š
  - ä¼˜ç‚¹ï¼šæŸ¥è¯¢å¿«
  - ç¼ºç‚¹ï¼šéœ€è¦åŒæ­¥æœºåˆ¶ï¼Œå¯èƒ½ä¸å‡†ç¡®

#### 2. VIP ç­‰çº§é…ç½®ç¡¬ç¼–ç 
**é—®é¢˜**: 
- VIP ç­‰çº§é˜ˆå€¼å’Œæ—¥åˆ©ç‡ç¡¬ç¼–ç åœ¨æ–‡æ¡£ä¸­
- æ— æ³•åŠ¨æ€è°ƒæ•´

**å»ºè®®**:
- ä½¿ç”¨ `system_config` è¡¨å­˜å‚¨é…ç½®
- æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
- æä¾› Admin API æ›´æ–°é…ç½®

#### 3. æŒå¸å¼€å§‹æ—¶é—´ç¡®å®šé€»è¾‘
**é—®é¢˜**: 
- æ–‡æ¡£è¯´ä½¿ç”¨ `claims` è¡¨çš„é¦–æ¬¡ `created_at`
- ä½†å¦‚æœç”¨æˆ·ä»æœªé¢†å–è¿‡ç©ºæŠ•ï¼Œä½†æœ‰ RAT ä½™é¢ï¼Œå¦‚ä½•è®¡ç®—ï¼Ÿ

**å»ºè®®**: 
- æ˜ç¡®ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰é¢†å–è¿‡ç©ºæŠ•çš„ç”¨æˆ·æ‰èƒ½è·å¾—æ”¶ç›Š
- æˆ–ï¼šä½¿ç”¨ `users.created_at` ä½œä¸ºæŒå¸å¼€å§‹æ—¶é—´

---

### ğŸŸ¢ ä»£ç è´¨é‡è‰¯å¥½

#### âœ… å·²å®ç°ä¸”æ­£ç¡®çš„åŠŸèƒ½

1. **é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨**: å®ç°å®Œå–„ï¼Œæ”¯æŒé‡è¯•å’Œæ•…éšœè½¬ç§»
2. **ç©ºæŠ•éªŒè¯**: å¹‚ç­‰æ€§ä¿è¯ï¼Œèƒ½é‡å¥–åŠ±é€»è¾‘æ­£ç¡®
3. **æç°é˜²é‡å¤**: 5 åˆ†é’Ÿå†…é‡å¤è¯·æ±‚è¿”å›å·²å­˜åœ¨è®°å½•
4. **RPC è¿æ¥æ± **: æ”¯æŒæ•…éšœè½¬ç§»
5. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

---

## 5. ğŸ“‹ å¾…åŠäº‹é¡¹æ¸…å•

### âœ… é«˜ä¼˜å…ˆçº§ï¼ˆå·²å®Œæˆï¼‰

- [x] **å®ç°æ”¶ç›Šè®¡ç®—æœåŠ¡** (`src/services/earnings.ts`) âœ…
  - [x] ä»é“¾ä¸Šè¯»å– RAT ä½™é¢ âœ…
  - [x] è®¡ç®—æŒå¸å¤©æ•°ï¼ˆåŸºäºé¦–æ¬¡ `claims.created_at`ï¼‰ âœ…
  - [x] å®ç° VIP ç­‰çº§å’Œæ—¥åˆ©ç‡è®¡ç®— âœ…
  - [x] å®ç°æ”¶ç›Šè®¡ç®—å…¬å¼ âœ…

- [x] **å®ç°æ”¶ç›ŠæŸ¥è¯¢ API** (`GET /api/asset/earnings`) âœ…
  - [x] åœ¨ `src/api/routes/asset.ts` æ·»åŠ è·¯ç”± âœ…
  - [x] è°ƒç”¨æ”¶ç›Šè®¡ç®—æœåŠ¡ âœ…

- [x] **å®ç° RAT ä½™é¢æŸ¥è¯¢ API** (`GET /api/asset/rat-balance`) âœ…
  - [x] ä»é“¾ä¸Šè¯»å–ä½™é¢ âœ…
  - [x] è¿”å›æ ¼å¼åŒ–çš„ä½™é¢ âœ…

- [x] **å®ç°å†å²è®°å½•æŸ¥è¯¢ API** âœ…
  - [x] `GET /api/user/claims` - ç©ºæŠ•å†å² âœ…
  - [x] `GET /api/user/referrals` - é‚€è¯·å†å² âœ…

### âœ… ä¸­ä¼˜å…ˆçº§ï¼ˆå·²å®Œæˆï¼‰

- [x] **ä¿®å¤æç°èƒ½é‡é˜ˆå€¼** âœ…
  - [x] å°† `minEnergyToWithdraw` ä» 50 æ”¹ä¸º 30 âœ…
  - [x] å–æ¶ˆèƒ½é‡é—¨æ§›ï¼Œåªéœ€æ»¡è¶³ 1 USDT = 10 èƒ½é‡çš„å…³ç³» âœ…
  - [x] å°†èƒ½é‡æ¶ˆè€—ä» `amount` æ”¹ä¸º `amount * 10` âœ…

- [ ] **å®ç° VIP ç­‰çº§é…ç½®**
  - [ ] ä»æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶è¯»å– VIP ç­‰çº§
  - [ ] æä¾› Admin API æ›´æ–°é…ç½®

### ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–ï¼‰

- [ ] **æ”¶ç›Šæ•°æ®åŒæ­¥æœºåˆ¶**
  - [ ] å†³å®šæ˜¯å®æ—¶è®¡ç®—è¿˜æ˜¯å®šæ—¶æ›´æ–°
  - [ ] å¦‚æœé€‰æ‹©å®šæ—¶æ›´æ–°ï¼Œå®ç°åå°ä»»åŠ¡

- [ ] **æŒå¸å¼€å§‹æ—¶é—´é€»è¾‘ä¼˜åŒ–**
  - [ ] æ˜ç¡®ä¸šåŠ¡è§„åˆ™
  - [ ] å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆä»æœªé¢†å–ç©ºæŠ•ä½†æœ‰ä½™é¢ï¼‰

---

## 6. ğŸ“Š æ€»ç»“

### æ¶æ„å®Œæ•´æ€§è¯„åˆ†

| æ¨¡å— | çŠ¶æ€ | å®Œæˆåº¦ |
|------|------|--------|
| é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨ | âœ… å·²å®ç° | 100% |
| æ”¶ç›Šè®¡ç®—å¼•æ“ | âœ… å·²å®ç° | 100% |
| æç°é£æ§ | âœ… å·²å®ç°å¹¶ä¿®å¤ | 100% |
| åŠ¨æ€é…ç½® | âš ï¸ éƒ¨åˆ†å®ç° | 30% |
| API æ¥å£ | âœ… å·²å®ç° | 100% |

### æ€»ä½“è¯„ä¼°

**ä¼˜ç‚¹**:
- é“¾ä¸Šäº‹ä»¶ç›‘å¬å™¨å®ç°å®Œå–„
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œåˆ†å±‚åˆç†
- é”™è¯¯å¤„ç†å’Œå¹‚ç­‰æ€§ä¿è¯è‰¯å¥½

**å·²å®Œæˆçš„å·¥ä½œ**:
- âœ… **æ”¶ç›Šè®¡ç®—å¼•æ“å·²å®ç°**ï¼Œè¿™æ˜¯ "Hold-to-Earn" æ¨¡å¼çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… **æ‰€æœ‰å‰ç«¯éœ€è¦çš„ API å·²å®ç°**ï¼Œå‰åç«¯å¯ä»¥æ­£å¸¸å¯¹æ¥
- âœ… **æç°ä¸šåŠ¡é€»è¾‘å·²ä¿®å¤**ï¼Œèƒ½é‡é˜ˆå€¼å’Œæ¶ˆè€—è®¡ç®—æ­£ç¡®

**å‰©ä½™ä¼˜åŒ–å»ºè®®**:
1. **å®Œå–„ VIP ç­‰çº§é…ç½®æœºåˆ¶**ï¼ˆå¯é€‰ï¼‰ï¼šä» `vip_tiers` è¡¨è¯»å–é…ç½®ï¼Œæ›¿ä»£ç¡¬ç¼–ç 
2. **å®ç°ç³»ç»Ÿé…ç½® API**ï¼ˆå¯é€‰ï¼‰ï¼š`GET /api/system/links`, `GET /api/system/announcement`
3. **å®ç°ç”¨æˆ·é€šçŸ¥ API**ï¼ˆå¯é€‰ï¼‰ï¼š`GET /api/user/notifications`

---

---

## 7. ğŸ“ æ›´æ–°æ—¥å¿—

### v1.1.0 (2024-12-25) - æ ¸å¿ƒåŠŸèƒ½å®ç°

**æ–°å¢åŠŸèƒ½**:
- âœ… å®ç°æ”¶ç›Šè®¡ç®—å¼•æ“ (`src/services/earnings.ts`)
  - ä»é“¾ä¸Šè¯»å– RAT ä½™é¢
  - è®¡ç®—æŒå¸å¤©æ•°å’Œ VIP ç­‰çº§
  - è®¡ç®—å†å²æ€»æ”¶ç›Šå’Œå¯é¢†æ”¶ç›Š
- âœ… å®ç°æ”¶ç›ŠæŸ¥è¯¢ API (`GET /api/asset/earnings`)
- âœ… å®ç° RAT ä½™é¢æŸ¥è¯¢ API (`GET /api/asset/rat-balance`)
- âœ… å®ç°ç©ºæŠ•å†å²æŸ¥è¯¢ API (`GET /api/user/claims`)
- âœ… å®ç°é‚€è¯·å†å²æŸ¥è¯¢ API (`GET /api/user/referrals`)

**ä¿®å¤é—®é¢˜**:
- âœ… ä¿®å¤æç°èƒ½é‡é˜ˆå€¼ï¼šä» 50 æ”¹ä¸º 30
- âœ… å–æ¶ˆèƒ½é‡é—¨æ§›ï¼šåªéœ€æ»¡è¶³ 1 USDT = 10 èƒ½é‡çš„å…³ç³»
- âœ… ä¿®å¤èƒ½é‡æ¶ˆè€—è®¡ç®—ï¼šä» `amount` æ”¹ä¸º `amount * 10`ï¼ˆ1 USDT = 10 Energyï¼‰
- âœ… ä¿®å¤èƒ½é‡é”å®šé€»è¾‘ï¼šä½¿ç”¨æ­£ç¡®çš„ `energyCost` å€¼

**æ¶æ„æ”¹è¿›**:
- âœ… æ›´æ–° `registerAssetRoutes` å‡½æ•°ç­¾åï¼Œæ”¯æŒ provider ä¼ é€’
- âœ… æ›´æ–° `server.ts`ï¼Œæ­£ç¡®ä¼ é€’ provider ä¾èµ–

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2024-12-25  
**æœ€åæ›´æ–°**: 2024-12-25  
**å®¡æŸ¥äºº**: AI æ¶æ„å®¡æŸ¥ç³»ç»Ÿ

