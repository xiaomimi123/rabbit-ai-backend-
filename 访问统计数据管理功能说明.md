# 访问统计数据管理功能说明

## 📋 功能概述

实现了访问统计数据的定期清理和监控功能，帮助管理员：
1. **监控数据库大小**：查看总记录数、估算大小、数据范围
2. **定期清理旧数据**：自动或手动清理指定天数前的数据
3. **查看数据分布**：按月查看数据分布情况

---

## ✅ 已实现功能

### 1. 后端服务功能

#### 1.1 数据统计 (`getAnalyticsStats`)
**文件**: `rabbit-ai-backend/src/services/analytics.ts`

**功能**:
- 获取总记录数
- 获取最旧和最新记录时间
- 估算数据库大小（每条记录约 500 字节）
- 按月统计记录数（最近 12 个月）

**返回数据**:
```typescript
{
  ok: boolean;
  totalRecords: number;
  oldestRecord: string | null;
  newestRecord: string | null;
  estimatedSize: string; // 例如 "125.50 MB"
  recordsByMonth: Array<{ month: string; count: number }>;
}
```

#### 1.2 清理旧数据 (`cleanupOldVisits`)
**文件**: `rabbit-ai-backend/src/services/analytics.ts`

**功能**:
- 删除指定天数前的访问记录
- 分批删除（每批 1000 条），避免一次性删除太多
- 返回删除的记录数

**参数**:
- `daysToKeep`: 保留最近 N 天的数据（默认 90 天）

**返回数据**:
```typescript
{
  ok: boolean;
  deletedCount: number;
  error?: string;
}
```

#### 1.3 定时清理任务
**文件**: `rabbit-ai-backend/src/index.ts`

**功能**:
- 如果启用了自动清理，会在服务启动时立即执行一次
- 然后按照配置的间隔时间定期执行清理

**配置环境变量**:
- `ANALYTICS_CLEANUP_ENABLED=true` - 启用自动清理（默认关闭）
- `ANALYTICS_CLEANUP_DAYS=90` - 保留最近 90 天的数据（默认 90 天）
- `ANALYTICS_CLEANUP_INTERVAL_HOURS=24` - 每 24 小时执行一次（默认 24 小时）

---

### 2. 后端 API 接口

#### 2.1 `GET /api/admin/analytics/stats`
**功能**: 获取数据库统计信息

**认证**: 需要管理员权限

**响应**:
```json
{
  "ok": true,
  "totalRecords": 12500,
  "oldestRecord": "2025-01-01T00:00:00.000Z",
  "newestRecord": "2026-01-03T10:00:00.000Z",
  "estimatedSize": "6.10 MB",
  "recordsByMonth": [
    { "month": "2026-01", "count": 5000 },
    { "month": "2025-12", "count": 7500 }
  ]
}
```

#### 2.2 `POST /api/admin/analytics/cleanup`
**功能**: 手动清理旧数据

**认证**: 需要管理员权限

**请求体**:
```json
{
  "daysToKeep": 90
}
```

**响应**:
```json
{
  "ok": true,
  "deletedCount": 2500
}
```

---

### 3. 管理后台 UI

**文件**: `rabbit-ai-admin/pages/Analytics.tsx`

**功能**:
- **数据统计卡片**：显示总记录数、估算大小、数据范围
- **月度分布图表**：显示最近 12 个月的数据分布
- **清理功能**：
  - 输入要保留的天数（1-3650 天）
  - 点击"清理旧数据"按钮
  - 显示清理结果（成功/失败）

---

## 🚀 使用方法

### 方法 1: 通过管理后台手动清理（推荐）

1. 登录管理后台
2. 进入"访问统计"页面
3. 在"数据管理"区域：
   - 查看当前数据统计
   - 输入要保留的天数（例如：90）
   - 点击"清理旧数据"按钮
   - 确认操作
4. 等待清理完成，查看结果

### 方法 2: 启用自动清理

1. 在后端环境变量中添加：
   ```
   ANALYTICS_CLEANUP_ENABLED=true
   ANALYTICS_CLEANUP_DAYS=90
   ANALYTICS_CLEANUP_INTERVAL_HOURS=24
   ```

2. 重启后端服务

3. 服务启动后会自动：
   - 立即执行一次清理
   - 然后每 24 小时自动执行一次

### 方法 3: 通过 API 直接调用

```bash
# 获取统计信息
curl -X GET "https://rabbit-ai-backend.onrender.com/api/admin/analytics/stats" \
  -H "Authorization: Bearer YOUR_ADMIN_API_KEY"

# 清理 90 天前的数据
curl -X POST "https://rabbit-ai-backend.onrender.com/api/admin/analytics/cleanup" \
  -H "Authorization: Bearer YOUR_ADMIN_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"daysToKeep": 90}'
```

---

## ⚙️ 配置说明

### 环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `ANALYTICS_CLEANUP_ENABLED` | 是否启用自动清理 | `false` | `true` |
| `ANALYTICS_CLEANUP_DAYS` | 保留最近 N 天的数据 | `90` | `90` |
| `ANALYTICS_CLEANUP_INTERVAL_HOURS` | 清理任务执行间隔（小时） | `24` | `24` |

### 推荐配置

**生产环境**:
```
ANALYTICS_CLEANUP_ENABLED=true
ANALYTICS_CLEANUP_DAYS=90
ANALYTICS_CLEANUP_INTERVAL_HOURS=24
```

**开发/测试环境**:
```
ANALYTICS_CLEANUP_ENABLED=false
```
（手动清理，避免误删测试数据）

---

## 📊 数据估算

### 存储空间估算

- **每条记录**: 约 500 字节
- **10,000 条记录**: 约 5 MB
- **100,000 条记录**: 约 50 MB
- **1,000,000 条记录**: 约 500 MB

### 清理建议

- **高访问量网站**（每天 > 1000 次访问）：
  - 建议保留 30-60 天
  - 每周清理一次

- **中等访问量网站**（每天 100-1000 次访问）：
  - 建议保留 90 天
  - 每月清理一次

- **低访问量网站**（每天 < 100 次访问）：
  - 可以保留 180 天或更长
  - 每季度清理一次

---

## ⚠️ 注意事项

1. **数据不可恢复**：清理操作会永久删除数据，无法恢复
2. **分批删除**：为了避免数据库压力，清理操作会分批进行（每批 1000 条）
3. **清理时间**：如果数据量很大，清理可能需要几分钟
4. **建议备份**：在清理大量数据前，建议先备份数据库

---

## 🔍 监控建议

### 定期检查

1. **每周检查一次**数据统计：
   - 总记录数是否正常增长
   - 数据库大小是否在合理范围内
   - 是否有异常的数据增长

2. **每月检查一次**清理效果：
   - 清理是否正常执行
   - 清理后数据量是否合理
   - 是否有数据丢失

### 告警设置

建议设置以下告警：
- 数据库大小超过 1 GB
- 总记录数超过 100 万
- 清理任务连续失败 3 次

---

## 🐛 故障排查

### 问题 1: 清理任务没有执行

**检查**:
1. 环境变量 `ANALYTICS_CLEANUP_ENABLED` 是否为 `true`
2. 后端日志中是否有清理任务的日志
3. 是否有错误信息

**解决**:
- 检查环境变量配置
- 查看后端日志
- 手动触发一次清理测试

### 问题 2: 清理速度很慢

**原因**:
- 数据量太大
- 数据库性能问题

**解决**:
- 分批清理（减少 `daysToKeep` 的值，多次执行）
- 在低峰期执行清理
- 优化数据库索引

### 问题 3: 清理后数据仍然很多

**检查**:
1. `daysToKeep` 的值是否太大
2. 是否有新的数据不断写入

**解决**:
- 调整 `daysToKeep` 的值
- 启用自动清理，定期执行

---

## 📝 更新日志

**2026-01-03**:
- ✅ 添加数据统计功能
- ✅ 添加清理旧数据功能
- ✅ 添加定时清理任务
- ✅ 添加管理后台 UI

---

**最后更新**: 2026-01-03

