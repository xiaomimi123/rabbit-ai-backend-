# è®¿é—®ç»Ÿè®¡åŠŸèƒ½é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜ç°è±¡
è®¿é—®ç»Ÿè®¡é¡µé¢æ²¡æœ‰æ˜¾ç¤ºæ•°æ®ï¼Œæ•°æ®åº“ä¸­æ²¡æœ‰è®¿é—®è®°å½•ã€‚

## æ’æŸ¥æ­¥éª¤

### 1. æ£€æŸ¥å‰ç«¯æ˜¯å¦å‘é€è¯·æ±‚

**åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š**
```javascript
// æ¸…é™¤ sessionStorageï¼Œå¼ºåˆ¶é‡æ–°ä¸ŠæŠ¥
sessionStorage.removeItem('rabbit_visit_recorded');
sessionStorage.removeItem('rabbit_session_id');

// åˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
// åº”è¯¥çœ‹åˆ°ï¼š
// [App] Starting to record page visit...
// [App] Recording page visit now...
// [App] ğŸ“¤ Sending visit record to: ...
```

**æ£€æŸ¥ç‚¹ï¼š**
- âœ… æ˜¯å¦çœ‹åˆ° `[App] ğŸ“¤ Sending visit record to:` æ—¥å¿—ï¼Ÿ
- âœ… URL æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ `/api/analytics/visit` æˆ–å®Œæ•´åç«¯åœ°å€ï¼‰ï¼Ÿ
- âœ… æ˜¯å¦æœ‰ç½‘ç»œé”™è¯¯ï¼ˆCORSã€404ã€500ç­‰ï¼‰ï¼Ÿ

### 2. æ£€æŸ¥åç«¯æ˜¯å¦æ¥æ”¶è¯·æ±‚

**æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š**
```
[Analytics API] Client IP: ...
[Analytics API] Rate limit check: ...
[Analytics API] Recording visit: ...
[Analytics] Inserting page visit: ...
[Analytics] âœ… Page visit inserted successfully: ...
```

**æ£€æŸ¥ç‚¹ï¼š**
- âœ… æ˜¯å¦æ”¶åˆ°è¯·æ±‚ï¼Ÿ
- âœ… IP åœ°å€æ˜¯å¦æ­£ç¡®è·å–ï¼Ÿ
- âœ… Rate Limit æ˜¯å¦é€šè¿‡ï¼Ÿ
- âœ… æ•°æ®åº“æ’å…¥æ˜¯å¦æˆåŠŸï¼Ÿ

### 3. æ£€æŸ¥æ•°æ®åº“

**åœ¨ Supabase SQL Editor æ‰§è¡Œï¼š**
```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
SELECT COUNT(*) FROM page_visits;

-- æŸ¥çœ‹æœ€è¿‘5æ¡è®°å½•
SELECT * FROM page_visits ORDER BY created_at DESC LIMIT 5;

-- æ£€æŸ¥è¡¨ç»“æ„
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'page_visits';
```

### 4. å¸¸è§é—®é¢˜

#### é—®é¢˜ A: sessionStorage é˜»æ­¢é‡å¤ä¸ŠæŠ¥
**ç—‡çŠ¶ï¼š** ç”¨æˆ·ä¹‹å‰è®¿é—®è¿‡ï¼Œä¸ä¼šå†æ¬¡ä¸ŠæŠ¥

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
sessionStorage.removeItem('rabbit_visit_recorded');
sessionStorage.removeItem('rabbit_session_id');
// ç„¶ååˆ·æ–°é¡µé¢
```

#### é—®é¢˜ B: CORS é”™è¯¯
**ç—‡çŠ¶ï¼š** æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º CORS é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åç«¯ `CORS_ORIGINS` ç¯å¢ƒå˜é‡
2. ç¡®ä¿åŒ…å«å‰ç«¯åŸŸåï¼ˆå¦‚ `https://rabbitdifi.com`ï¼‰
3. é‡å¯åç«¯æœåŠ¡

#### é—®é¢˜ C: API è·¯å¾„é”™è¯¯
**ç—‡çŠ¶ï¼š** 404 Not Found é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥å‰ç«¯ `VITE_API_BASE_URL` ç¯å¢ƒå˜é‡
2. ç¡®ä¿æŒ‡å‘æ­£ç¡®çš„åç«¯åœ°å€
3. æ£€æŸ¥åç«¯è·¯ç”±æ˜¯å¦æ­£ç¡®æ³¨å†Œ

#### é—®é¢˜ D: Rate Limit æ‹¦æˆª
**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤º `Rate limit exceeded`

**è§£å†³æ–¹æ¡ˆï¼š**
- å½“å‰ Rate Limit æ˜¯ 1 åˆ†é’Ÿå†…åŒä¸€ IP åªèƒ½å‘ 1 æ¬¡è¯·æ±‚
- å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œä¸åº”è¯¥è§¦å‘
- å¦‚æœè§¦å‘ï¼Œç­‰å¾… 1 åˆ†é’Ÿåé‡è¯•

#### é—®é¢˜ E: IP è·å–å¤±è´¥
**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤º `Client IP is null`

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `CF-Connecting-IP` æˆ– `X-Forwarded-For`
- å¦‚æœæ˜¯æœ¬åœ°æµ‹è¯•ï¼ŒIP å¯èƒ½ä¸º nullï¼Œè¿™æ˜¯æ­£å¸¸çš„
- ç”Ÿäº§ç¯å¢ƒåº”è¯¥èƒ½æ­£ç¡®è·å– IP

### 5. æ‰‹åŠ¨æµ‹è¯• API

**ä½¿ç”¨ curl æµ‹è¯•ï¼š**
```bash
curl -X POST https://your-backend-url/api/analytics/visit \
  -H "Content-Type: application/json" \
  -H "CF-Connecting-IP: 8.8.8.8" \
  -d '{
    "pagePath": "/test",
    "walletAddress": null,
    "referrer": null,
    "language": "zh",
    "isMobile": false,
    "sessionId": "test_123"
  }'
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "ok": true,
  "message": "Visit recorded"
}
```

### 6. æ£€æŸ¥åç«¯æ—¥å¿—

**å…³é”®æ—¥å¿—ä½ç½®ï¼š**
1. `[Analytics API] Client IP:` - IP è·å–
2. `[Analytics API] Rate limit check:` - Rate Limit æ£€æŸ¥
3. `[Analytics] Inserting page visit:` - æ•°æ®åº“æ’å…¥
4. `[Analytics] âœ… Page visit inserted successfully:` - æ’å…¥æˆåŠŸ

**å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š**
- `Failed to insert page visit:` - æ•°æ®åº“é”™è¯¯ï¼Œæ£€æŸ¥è¡¨ç»“æ„å’Œæƒé™
- `Rate limit exceeded` - Rate Limit æ‹¦æˆª
- `IP address is missing` - IP è·å–å¤±è´¥ï¼ˆå¯èƒ½æ­£å¸¸ï¼Œå¦‚æœ IP ä¸º null ä¹Ÿä¼šç»§ç»­å¤„ç†ï¼‰

## å¿«é€Ÿä¿®å¤

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ­£å¸¸ï¼Œä½†ä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ï¼š

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ sessionStorage**
2. **ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®ç½‘ç«™**
3. **æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ**
4. **æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸**

## è”ç³»æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—
2. åç«¯æœåŠ¡å™¨çš„å®Œæ•´æ—¥å¿—
3. æ•°æ®åº“æŸ¥è¯¢ç»“æœ
4. ç½‘ç»œè¯·æ±‚è¯¦æƒ…ï¼ˆNetwork æ ‡ç­¾ï¼‰

