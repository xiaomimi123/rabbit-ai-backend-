# 访问统计数据不显示 - 详细排查步骤

## 🔍 问题现象
后端日志中**完全没有** `POST /api/analytics/visit` 的请求记录，说明前端请求根本没有到达后端。

## 📋 排查步骤（按顺序执行）

### 步骤 1: 检查前端是否发送请求

**在浏览器控制台执行：**
```javascript
// 1. 清除 sessionStorage，强制重新上报
sessionStorage.removeItem('rabbit_visit_recorded');
sessionStorage.removeItem('rabbit_wallet_recorded');
sessionStorage.removeItem('rabbit_session_id');

// 2. 检查 API Base URL 配置
const { getApiBaseUrl } = await import('./api');
console.log('API Base URL:', getApiBaseUrl());

// 3. 手动测试发送请求
const apiBase = getApiBaseUrl();
const visitUrl = apiBase.endsWith('/') 
  ? `${apiBase}analytics/visit` 
  : `${apiBase}/analytics/visit`;

console.log('Visit URL:', visitUrl);

fetch(visitUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    pagePath: window.location.pathname,
    walletAddress: null,
    referrer: null,
    language: 'zh',
    isMobile: /android|iphone|ipad|ipod/i.test(navigator.userAgent),
    sessionId: `test_${Date.now()}`,
  }),
})
.then(res => {
  console.log('Response status:', res.status);
  console.log('Response ok:', res.ok);
  return res.json();
})
.then(data => {
  console.log('Response data:', data);
})
.catch(err => {
  console.error('Request failed:', err);
});
```

**检查点：**
- ✅ 是否看到 `API Base URL` 输出？值是什么？
- ✅ 是否看到 `Visit URL` 输出？URL 是否正确？
- ✅ 请求是否成功（status 200）？
- ✅ 是否有 CORS 错误？
- ✅ 是否有网络错误（404、500等）？

---

### 步骤 2: 检查浏览器 Network 面板

1. 打开浏览器开发者工具（F12）
2. 切换到 **Network** 标签
3. 清除之前的请求记录
4. **清除 sessionStorage**（见步骤1）
5. **刷新页面**
6. 在 Network 面板中搜索 `analytics/visit`

**检查点：**
- ✅ 是否有 `POST /api/analytics/visit` 请求？
- ✅ 请求的 URL 是什么？（完整地址）
- ✅ 请求状态码是什么？（200、404、500、CORS 错误等）
- ✅ 请求的 Request Headers 是什么？
- ✅ 请求的 Request Payload 是什么？
- ✅ 请求的 Response 是什么？

**如果请求不存在：**
- 说明前端代码没有执行 `recordVisit()` 函数
- 检查浏览器控制台是否有 JavaScript 错误
- 检查 `sessionStorage` 是否阻止了上报

**如果请求存在但失败：**
- **CORS 错误**：检查后端 CORS 配置
- **404 错误**：检查 API Base URL 是否正确
- **500 错误**：查看后端日志

---

### 步骤 3: 检查后端路由注册

**在后端日志中搜索：**
```
registerAnalyticsRoutes
```

**检查点：**
- ✅ 后端启动时是否注册了 analytics 路由？
- ✅ 是否有路由注册错误？

**如果路由未注册：**
检查 `rabbit-ai-backend/src/server.ts` 文件，确保：
```typescript
registerAnalyticsRoutes(app);
```
这行代码存在且没有被注释。

---

### 步骤 4: 直接测试后端 API

**使用 curl 或 Postman 直接测试后端 API：**

```bash
curl -X POST https://rabbit-ai-backend.onrender.com/api/analytics/visit \
  -H "Content-Type: application/json" \
  -H "Origin: https://rabbitdifi.com" \
  -d '{
    "pagePath": "/",
    "walletAddress": null,
    "referrer": null,
    "language": "zh",
    "isMobile": false,
    "sessionId": "test_manual"
  }'
```

**检查点：**
- ✅ 请求是否成功（返回 `{"ok": true}`）？
- ✅ 后端日志是否显示请求？
- ✅ 数据库中是否插入记录？

**如果直接测试成功，但前端请求失败：**
- 说明是前端配置问题（API Base URL、CORS 等）
- 继续排查前端配置

---

### 步骤 5: 检查环境变量配置

**前端环境变量（Vercel/Cloudflare）：**
- `VITE_API_BASE_URL` 应该设置为：`https://rabbit-ai-backend.onrender.com`

**后端环境变量（Render）：**
- `CORS_ORIGINS` 应该包含前端域名：`https://rabbitdifi.com`

**检查方法：**
1. 登录 Vercel/Cloudflare 控制台
2. 查看前端项目的环境变量
3. 登录 Render 控制台
4. 查看后端项目的环境变量

---

### 步骤 6: 检查数据库

**在 Supabase SQL Editor 执行：**
```sql
-- 检查是否有数据
SELECT COUNT(*) as total FROM page_visits;

-- 查看最近5条记录
SELECT 
  id,
  ip_address,
  country,
  page_path,
  wallet_address,
  created_at
FROM page_visits 
ORDER BY created_at DESC 
LIMIT 5;

-- 检查表权限
SELECT 
  grantee,
  privilege_type
FROM information_schema.role_table_grants
WHERE table_name = 'page_visits';
```

**检查点：**
- ✅ 表中是否有数据？
- ✅ 如果有数据，`ip_address` 是否正确？
- ✅ 表权限是否正确（`service_role` 应该有所有权限）？

---

## 🐛 常见问题及解决方案

### 问题 1: sessionStorage 阻止重复上报

**症状：**
- 用户之前访问过网站
- `sessionStorage` 中已有 `rabbit_visit_recorded = 'true'`
- 页面刷新后不会再次上报

**解决方案：**
```javascript
// 在浏览器控制台执行
sessionStorage.removeItem('rabbit_visit_recorded');
sessionStorage.removeItem('rabbit_wallet_recorded');
sessionStorage.removeItem('rabbit_session_id');
// 然后刷新页面
```

---

### 问题 2: API Base URL 配置错误

**症状：**
- 前端请求发送到错误的地址（如前端自己的地址）
- 浏览器 Network 面板显示 404 错误

**解决方案：**
1. 检查前端环境变量 `VITE_API_BASE_URL`
2. 确保值设置为：`https://rabbit-ai-backend.onrender.com`
3. 重新部署前端

---

### 问题 3: CORS 错误

**症状：**
- 浏览器控制台显示 CORS 错误
- Network 面板显示 `OPTIONS` 请求失败

**解决方案：**
1. 检查后端环境变量 `CORS_ORIGINS`
2. 确保包含前端域名：`https://rabbitdifi.com`
3. 重新部署后端

---

### 问题 4: Rate Limit 拦截

**症状：**
- 后端日志显示 `Rate limit exceeded`
- 请求被静默拒绝（返回 `ok: false`）

**解决方案：**
- 等待 1 分钟后重试
- 或者检查 `checkRateLimit` 函数逻辑

---

### 问题 5: IP 地址获取失败

**症状：**
- 后端日志显示 `Client IP is null`
- 数据库中 `ip_address` 为 `null`

**解决方案：**
- 检查 Cloudflare/Vercel 代理配置
- 检查 `getClientIp` 函数逻辑
- 查看后端日志中的 IP 头信息

---

## 📊 诊断结果记录

请按照以下格式记录诊断结果：

```
### 步骤 1: 前端请求检查
- API Base URL: [填写值]
- Visit URL: [填写值]
- 请求是否发送: [是/否]
- 请求状态: [200/404/500/CORS错误/其他]
- 浏览器控制台错误: [填写错误信息]

### 步骤 2: Network 面板检查
- 请求是否存在: [是/否]
- 请求 URL: [填写完整URL]
- 请求状态码: [填写状态码]
- Request Headers: [填写关键头信息]
- Response: [填写响应内容]

### 步骤 3: 后端路由检查
- 路由是否注册: [是/否]
- 后端日志: [填写相关日志]

### 步骤 4: 直接测试后端
- curl 测试结果: [成功/失败]
- 响应内容: [填写响应]
- 后端日志: [填写相关日志]

### 步骤 5: 环境变量检查
- VITE_API_BASE_URL: [填写值]
- CORS_ORIGINS: [填写值]

### 步骤 6: 数据库检查
- 表中记录数: [填写数字]
- 最近记录: [填写记录内容]
```

---

## 🎯 下一步行动

根据诊断结果，确定问题所在：

1. **如果前端没有发送请求** → 检查前端代码和 `sessionStorage`
2. **如果请求发送但失败（CORS/404）** → 检查环境变量配置
3. **如果请求到达后端但被拒绝** → 检查 Rate Limit 和 IP 获取逻辑
4. **如果请求成功但数据库无数据** → 检查数据库插入逻辑和权限

---

**最后更新**: 2026-01-03
**排查人**: [填写你的名字]

