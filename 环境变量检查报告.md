# 后端环境变量检查报告

**检查日期**: 2024-12-25  
**检查范围**: 新增功能所需的环境变量  
**检查目的**: 确保所有新增功能都有必需的环境变量配置

---

## 📋 新增功能环境变量需求

### 1. 财务流水模块 (Accounting)

#### `getFinanceRevenue` (收益明细)
**需要的环境变量**:
- ✅ `AIRDROP_CONTRACT` - **必需**（用于读取 `claimFee`）

**当前状态**: ✅ **已存在**（必需环境变量）

#### `getFinanceExpenses` (支出明细)
**需要的环境变量**:
- ❌ 无需环境变量（只查询数据库）

**当前状态**: ✅ **无需配置**

---

### 2. 收益计算引擎 (Earnings)

#### `calculateUserEarnings`
**需要的环境变量**:
- ✅ `RAT_TOKEN_CONTRACT` - **必需**（用于读取链上 RAT 余额）

**当前状态**: ⚠️ **已存在但标记为可选**

**代码检查**:
```typescript
// src/services/earnings.ts:29
if (!config.ratTokenContract) {
  throw new ApiError('CONFIG_ERROR', 'RAT_TOKEN_CONTRACT not configured', 500);
}
```

**问题**: 
- 代码中会抛出错误，但 `config.ts` 中标记为 `optionalStr`
- 如果未配置，会导致收益计算功能无法使用

**建议**: 
- ⚠️ **重要**: 确保生产环境配置了 `RAT_TOKEN_CONTRACT`
- 或者将 `RAT_TOKEN_CONTRACT` 改为必需环境变量

---

### 3. VIP 配置动态读取 (VIP Config)

#### `loadVipTiers`, `getVipTierByBalance`
**需要的环境变量**:
- ❌ 无需环境变量（从数据库 `vip_tiers` 表读取）

**当前状态**: ✅ **无需配置**

---

## 📊 环境变量完整性检查

### 必需环境变量（新增功能）

| 环境变量 | 功能模块 | 是否必需 | 当前状态 | 备注 |
|---------|---------|---------|---------|------|
| `AIRDROP_CONTRACT` | 财务流水-收益 | ✅ 必需 | ✅ 已存在 | 用于读取 `claimFee` |
| `RAT_TOKEN_CONTRACT` | 收益计算引擎 | ✅ 必需 | ⚠️ 可选但必需 | 代码会检查，未配置会报错 |

### 可选环境变量（其他功能）

| 环境变量 | 功能模块 | 是否必需 | 当前状态 | 备注 |
|---------|---------|---------|---------|------|
| `USDT_CONTRACT` | 财务审核 | ⚠️ 可选 | ✅ 已存在 | 用于 USDT 发放和校验 |
| `ADMIN_PAYOUT_ADDRESS` | 财务审核 | ⚠️ 可选 | ✅ 已存在 | 用于链上校验打款地址 |
| `STAKING_CONTRACT` | TVL 计算 | ⚠️ 可选 | ✅ 已存在 | 用于计算 TVL（已废弃） |

---

## ⚠️ 发现的问题和建议

### 1. `RAT_TOKEN_CONTRACT` 配置不一致

**问题**: 
- `config.ts` 中标记为 `optionalStr`（可选）
- `earnings.ts` 中会检查并抛出错误（必需）

**影响**: 
- 如果未配置 `RAT_TOKEN_CONTRACT`，收益计算功能会报错
- 前端调用 `/api/asset/earnings` 会返回 500 错误

**建议**: 
- **方案 A（推荐）**: 确保生产环境配置了 `RAT_TOKEN_CONTRACT`
- **方案 B**: 将 `RAT_TOKEN_CONTRACT` 改为必需环境变量（修改 `config.ts`）

**当前 `env.example` 状态**: ✅ 已包含 `RAT_TOKEN_CONTRACT=0x03853d1B9a6DEeCE10ADf0EE20D836f06aFca47B`

---

## ✅ 环境变量配置清单

### 必需环境变量（核心功能）

```bash
# Supabase
SUPABASE_URL=https://xxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# BSC RPC
BSC_RPC_URLS=https://bsc-dataseed1.binance.org/,https://bsc-dataseed2.binance.org/

# 合约地址（必需）
AIRDROP_CONTRACT=0x16B7a2e6eD9a0Ace9495b80eF0A5D0e3f72aCD7c
RAT_TOKEN_CONTRACT=0x03853d1B9a6DEeCE10ADf0EE20D836f06aFca47B  # ⚠️ 收益计算必需
```

### 可选环境变量（增强功能）

```bash
# 财务审核功能（可选，但建议配置）
USDT_CONTRACT=0x55d398326f99059fF775485246999027B3197955  # BSC 主网 USDT
ADMIN_PAYOUT_ADDRESS=0x...  # 管理员打款地址

# 其他配置
CORS_ORIGINS=*
ADMIN_API_KEY=change_me
WITHDRAW_ALERT_THRESHOLD=1000
```

---

## 📝 配置建议

### 生产环境配置清单

**必需配置**:
1. ✅ `SUPABASE_URL` - Supabase 项目 URL
2. ✅ `SUPABASE_SERVICE_ROLE_KEY` - Supabase 服务角色密钥
3. ✅ `BSC_RPC_URLS` - BSC RPC 节点（逗号分隔，支持故障转移）
4. ✅ `AIRDROP_CONTRACT` - 空投合约地址
5. ✅ `RAT_TOKEN_CONTRACT` - **收益计算必需**，必须配置

**建议配置**:
1. ⚠️ `USDT_CONTRACT` - 用于财务审核的 USDT 发放和校验
2. ⚠️ `ADMIN_PAYOUT_ADDRESS` - 用于链上校验打款地址
3. ⚠️ `ADMIN_API_KEY` - 管理后台认证密钥
4. ⚠️ `CORS_ORIGINS` - CORS 白名单（生产环境建议配置具体域名）

---

## 🎯 总结

### 环境变量完整性评分

| 项目 | 评分 | 说明 |
|------|------|------|
| 必需环境变量 | ✅ 100% | 所有必需变量都已定义 |
| 可选环境变量 | ✅ 100% | 所有可选变量都已定义 |
| 配置一致性 | ⚠️ 90% | `RAT_TOKEN_CONTRACT` 标记不一致 |

**总体评分**: ✅ **95%** - 环境变量配置完整，只需注意 `RAT_TOKEN_CONTRACT` 的配置

---

## ✅ 结论

**环境变量状态**: ✅ **基本完整**

- ✅ 所有新增功能所需的环境变量都已定义
- ✅ `env.example` 文件包含所有必需变量
- ⚠️ **注意**: `RAT_TOKEN_CONTRACT` 必须配置，否则收益计算功能无法使用

**无需新增环境变量**，现有配置已满足所有新增功能需求。

**重要提醒**: 
- 确保生产环境配置了 `RAT_TOKEN_CONTRACT`
- 建议配置 `USDT_CONTRACT` 和 `ADMIN_PAYOUT_ADDRESS` 以支持完整的财务审核功能

---

**报告生成时间**: 2024-12-25  
**检查人**: AI 环境变量检查系统

